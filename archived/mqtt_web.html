<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Web Client</title>
    <!-- Menggunakan Library Paho MQTT dari CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .panel h3 {
            margin-top: 0;
        }

        .row {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            width: 80px;
            font-weight: bold;
        }

        input[type="text"] {
            flex: 1;
            padding: 5px;
        }

        button {
            padding: 5px 15px;
            cursor: pointer;
        }

        #status {
            font-weight: bold;
            color: red;
        }

        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #eee;
            background: #f9f9f9;
            padding: 10px;
            font-family: monospace;
        }

        .msg-item {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 2px;
        }

        .msg-time {
            color: #888;
            font-size: 0.8em;
            margin-right: 10px;
        }

        .msg-topic {
            color: #0066cc;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <h2>MQTT Web Client (WebSocket)</h2>

    <div class="panel">
        <h3>1. Koneksi Broker</h3>
        <div class="row">
            <label>Host:</label>
            <input type="text" id="host" value="192.168.20.67">
            <label>Port (WS):</label>
            <input type="text" id="port" value="9001" style="width: 60px; flex: none;">
        </div>
        <div class="row">
            <label>Status:</label>
            <span id="status">Disconnected</span>
        </div>
        <div class="row">
            <button id="btn-connect" onclick="connect()">Connect</button>
            <button id="btn-disconnect" onclick="disconnect()" disabled>Disconnect</button>
        </div>
        <p style="font-size: 0.9em; color: #666;">
            <strong>Catatan:</strong> Browser menggunakan <em>WebSockets</em>. Pastikan Broker MQTT Anda mendukung
            WebSockets (biasanya port 9001).
        </p>
    </div>

    <div class="panel">
        <h3>2. Subscribe</h3>
        <div class="row">
            <label>Topic:</label>
            <input type="text" id="sub-topic" value="tes/#">
            <button id="btn-sub" onclick="subscribe()" disabled>Subscribe</button>
        </div>
    </div>

    <div class="panel">
        <h3>3. Publish</h3>
        <div class="row">
            <label>Topic:</label>
            <input type="text" id="pub-topic" value="tes/mqtt">
        </div>
        <div class="row">
            <label>Pesan:</label>
            <input type="text" id="pub-msg" value="Halo dari Web Browser!">
            <button id="btn-pub" onclick="publish()" disabled>Publish</button>
        </div>
    </div>

    <div class="panel">
        <h3>Log Pesan</h3>
        <div class="row">
            <button onclick="document.getElementById('messages').innerHTML = ''">Clear Log</button>
        </div>
        <div id="messages"></div>
    </div>

    <script>
        let client;
        const statusSpan = document.getElementById("status");
        const btnConnect = document.getElementById("btn-connect");
        const btnDisconnect = document.getElementById("btn-disconnect");
        const btnSub = document.getElementById("btn-sub");
        const btnPub = document.getElementById("btn-pub");

        function connect() {
            const host = document.getElementById("host").value;
            const port = Number(document.getElementById("port").value);
            const clientId = "clientID-" + parseInt(Math.random() * 100);

            statusSpan.innerText = "Connecting...";
            statusSpan.style.color = "orange";

            // Membuat instance client
            client = new Paho.MQTT.Client(host, port, clientId);

            // Callback handler
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // Opsi koneksi
            const options = {
                onSuccess: onConnect,
                onFailure: onFail,
                // keepAliveInterval: 30,
            };

            // Mencoba koneksi
            client.connect(options);
        }

        function onConnect() {
            console.log("onConnect");
            statusSpan.innerText = "Connected";
            statusSpan.style.color = "green";

            btnConnect.disabled = true;
            btnDisconnect.disabled = false;
            btnSub.disabled = false;
            btnPub.disabled = false;
        }

        function onFail(responseObject) {
            console.log("onFail: " + responseObject.errorMessage);
            statusSpan.innerText = "Failed: " + responseObject.errorMessage;
            statusSpan.style.color = "red";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                statusSpan.innerText = "Disconnected (" + responseObject.errorMessage + ")";
            } else {
                statusSpan.innerText = "Disconnected";
            }
            statusSpan.style.color = "red";

            btnConnect.disabled = false;
            btnDisconnect.disabled = true;
            btnSub.disabled = true;
            btnPub.disabled = true;
        }

        function disconnect() {
            if (client) {
                client.disconnect();
            }
        }

        function subscribe() {
            const topic = document.getElementById("sub-topic").value;
            if (client && topic) {
                client.subscribe(topic);
                logMessage("System", `Subscribed to ${topic}`);
            }
        }

        function publish() {
            const topic = document.getElementById("pub-topic").value;
            const msgText = document.getElementById("pub-msg").value;

            if (client && topic && msgText) {
                message = new Paho.MQTT.Message(msgText);
                message.destinationName = topic;
                client.send(message);
                // logMessage(topic, msgText + " [SENT]"); // Optional: log sent messages
            }
        }

        function onMessageArrived(message) {
            console.log("onMessageArrived:" + message.payloadString);
            logMessage(message.destinationName, message.payloadString);
        }

        function logMessage(topic, payload) {
            const messagesDiv = document.getElementById("messages");
            const time = new Date().toLocaleTimeString();

            const msgHtml = `
                <div class="msg-item">
                    <span class="msg-time">[${time}]</span>
                    <span class="msg-topic">${topic}</span>
                    <span class="msg-content">${payload}</span>
                </div>
            `;
            messagesDiv.innerHTML += msgHtml;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>

</html>